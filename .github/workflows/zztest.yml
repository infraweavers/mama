name: zztest

on: [workflow_dispatch]

jobs:

  build-release:
  
    strategy:
      matrix:
        go-version: [1.15.x, 1.16.x]
        os: [windows]
        arch: [386, amd64]
        
    runs-on: windows-latest
    env:
        SRCPATH: ${{ github.workspace }}/go/src/mama

    steps:
        
      - uses: benjlevesque/short-sha@v1.2
        id: short-sha
        with:
          length: 7

      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go-version }}
          
      - name: Install WIX Tool Set
        run: |
          Invoke-WebRequest -UseBasicParsing -Uri https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311.exe -OutFile wix311.exe
          & ".\wix311.exe" "/q"
            
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          path: ${{ env.SRCPATH }}

      - name: Dependencies & Build
        run: |
          $os="${{ matrix.os }}"
          $arch="${{ matrix.arch }}"
          $goversion="${{ matrix.go-version }}"
          Write-Host "Building $os-$arch-$goversion"
          
          New-Item -Type Directory ./release/$os-$arch-$goversion
          
          Set-Location -Path ${{ env.SRCPATH }}
          
          $env:GO111MODULE="on" 
          $env:GOOS="$os"
          $env:GOARCH=$arch
          go get ./...
          go build -o ${{ env.SRCPATH }}/monitoring-agent.exe
          
      - name: Create MSI Installer
        run: |
          $os="${{ matrix.os }}"
          $arch="${{ matrix.arch }}"
          $goversion="${{ matrix.go-version }}"
          
          $win_arch = "x64"
          if ($arch = "386") { $win_arch = "x86" }

          Write-Host "Building MSI Installer For $os-$arch-$goversion"
          
          Push-Location -Path ${{ env.SRCPATH }}
          & 'C:\Program Files (x86)\WiX Toolset v3.11\bin\candle.exe' .\monitoring-agent.wxs -arch $win_arch -dPlatform="$($win_arch)" -dProductId="$(new-guid)" -dGitSha="${{ steps.short-sha.outputs.sha }}"
          & "C:\Program Files (x86)\WiX Toolset v3.11\bin\light.exe" "./monitoring-agent.wixobj"
          Pop-Location
          Get-ChildItem ${{ env.SRCPATH }}/monitoring-agent.msi
          Get-ChildItem ./release/$os-$arch-$goversion
          Write-Host Move-Item -Path ${{ env.SRCPATH }}/monitoring-agent.msi -Destination "./release/$($os)-$($arch)-$($goversion)/monitoring-agent-$($win_arch)-$($goversion)-${{ steps.short-sha.outputs.sha }}.msi"
          Move-Item -Path ${{ env.SRCPATH }}/monitoring-agent.msi -Destination "./release/$($os)-$($arch)-$($goversion)/monitoring-agent-$($win_arch)-$($goversion)-${{ steps.short-sha.outputs.sha }}.msi"

      - name: upload MSI
        uses: actions/upload-artifact@v2
        with:
          name: "${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.go-version }}-${{ steps.short-sha.outputs.sha }}"
          path: release/
